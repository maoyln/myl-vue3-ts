# 面板组功能优化说明

## 优化内容

### 1. ✅ 吸附位置预览指示器

**需求：**
拖拽标签页到其他面板组时，需要显示明显的合并预览效果。

**实现方案：**

#### 动态显示指示器
使用 computed 属性根据 `hoveredGroup` 状态显示：

```typescript
const showMergeIndicator = computed(() => {
  return manager.hoveredGroup?.value === props.group.id;
});
```

#### 增强视觉效果
```css
.merge-indicator {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 36px; /* 只覆盖标签栏区域 */
  border: 3px solid #4A90E2;
  background: linear-gradient(...); /* 渐变背景 */
  animation: pulse 0.6s infinite alternate; /* 脉冲动画 */
  box-shadow: ...; /* 发光效果 */
}

.merge-indicator::before {
  content: '拖到这里合并标签页';
  /* 提示文字居中显示 */
}
```

**效果：**
- ✅ 拖拽标签页时，目标面板组的标签栏区域会高亮
- ✅ 蓝色边框和渐变背景，带脉冲动画
- ✅ 显示"拖到这里合并标签页"提示文字
- ✅ 发光效果，非常明显

---

### 2. ✅ 标签页最小宽度与面板自动扩展

**需求：**
- 每个标签页有最小宽度（120px）
- 当标签页总宽度超过面板宽度时，自动扩展面板宽度
- 显示所有标签页，避免被截断

**实现方案：**

#### 设置最小宽度
```css
.panel-tab {
  min-width: 120px; /* 增加到120px */
  max-width: 200px;
  flex-shrink: 0; /* 不缩小 */
}
```

#### 自动计算并调整宽度
```typescript
function adjustPanelWidth() {
  if (!props.group.tabs || props.group.tabs.length === 0) return;
  
  // 计算所有标签页需要的总宽度
  let totalTabsWidth = 0;
  props.group.tabs.forEach(tab => {
    // 基础宽度：内边距 + 图标 + 文字 + 关闭按钮
    let tabWidth = tabPadding;
    if (tab.icon) tabWidth += iconWidth;
    if (tab.closable !== false && props.group.tabs.length > 1) {
      tabWidth += closeButtonWidth;
    }
    // 文字宽度估算
    const titleWidth = (tab.title?.length || 0) * 8;
    tabWidth += titleWidth;
    
    // 应用最小宽度
    tabWidth = Math.max(tabWidth, minTabWidth);
    totalTabsWidth += tabWidth;
  });
  
  // 加上操作按钮区域的宽度
  const actionsWidth = 80;
  const requiredWidth = totalTabsWidth + actionsWidth;
  
  // 如果需要的宽度大于当前宽度，自动扩展
  if (requiredWidth > props.group.width) {
    const newWidth = Math.min(requiredWidth, 800); // 最大800px
    manager.resizePanelGroup?.(props.group.id, newWidth, props.group.height);
  }
}

// 监听标签页数量变化
watch(() => props.group.tabs.length, () => {
  adjustPanelWidth();
}, { immediate: true });
```

**计算公式：**
```
单个标签宽度 = 内边距(24) + 图标(20) + 文字(字数×8) + 关闭按钮(16)
总宽度 = max(单个标签宽度, 120) × 标签数 + 操作按钮(80)
面板宽度 = min(总宽度, 800)
```

**效果：**
- ✅ 标签页最小宽度120px，保证可读性
- ✅ 添加新标签时，面板自动扩展
- ✅ 所有标签页都能完整显示
- ✅ 最大宽度限制800px，避免过宽

---

### 3. ✅ 区分点击和拖拽操作

**需求：**
- 点击标签页：切换到该标签
- 拖拽标签页：拆分或合并标签
- 不应该点击就触发拖拽

**问题原因：**
原代码在 `mousedown` 时立即启动拖拽，导致任何点击都被识别为拖拽。

**解决方案：延迟拖拽判断**

```typescript
const dragStartPos = ref({ x: 0, y: 0 });
const dragThreshold = 5; // 拖拽阈值（像素）
const hasDragged = ref(false);

function handleTabMouseDown(e: MouseEvent, tab: TabItem) {
  e.stopPropagation();
  
  // 记录起始位置
  dragStartPos.value = { x: e.clientX, y: e.clientY };
  hasDragged.value = false;
  
  // 监听鼠标移动
  const handleMouseMove = (moveEvent: MouseEvent) => {
    const deltaX = Math.abs(moveEvent.clientX - dragStartPos.value.x);
    const deltaY = Math.abs(moveEvent.clientY - dragStartPos.value.y);
    
    // 超过阈值才开始拖拽
    if (deltaX > dragThreshold || deltaY > dragThreshold) {
      if (!hasDragged.value) {
        hasDragged.value = true;
        isDraggingTab.value = true;
        
        // 启动标签页拖拽
        manager.startDragTab?.(
          props.group.id, 
          tab.id, 
          moveEvent.clientX, 
          moveEvent.clientY
        );
      }
    }
  };
  
  // 监听鼠标释放
  const handleMouseUp = () => {
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    
    if (!hasDragged.value) {
      // 如果没有拖拽，就是点击，切换标签
      handleTabClick(tab.id);
    }
    
    isDraggingTab.value = false;
  };
  
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);
}
```

**逻辑流程：**

1. **mousedown**: 记录起始位置
2. **mousemove**: 
   - 计算移动距离
   - 距离 > 5px 时才启动拖拽
3. **mouseup**: 
   - 如果没有拖拽 → 触发点击事件（切换标签）
   - 如果已拖拽 → 结束拖拽

**效果：**
- ✅ 点击标签页切换内容，不触发拖拽
- ✅ 拖动标签页（移动>5px）才开始拖拽
- ✅ 拖拽体验更精确，避免误操作

---

## 代码变更文件

1. **DockablePanelGroup.vue**
   - 添加合并指示器显示逻辑
   - 实现标签页宽度自动调整
   - 修复点击/拖拽识别问题
   - 增强合并指示器样式

## 测试方法

### 测试1：合并预览指示器
1. 创建2个面板组
2. 拖动第一个面板的标签页
3. 移动到第二个面板的标签栏上方
4. ✅ 应该看到蓝色高亮边框和"拖到这里合并标签页"文字
5. 释放鼠标，标签页合并成功

### 测试2：标签页宽度调整
1. 创建一个面板组
2. 拖动另外3-4个标签到这个面板组合并
3. ✅ 面板应该自动变宽，显示所有标签
4. 所有标签页都应该完整显示，不被截断

### 测试3：点击vs拖拽
1. 创建一个有多个标签的面板组
2. **点击**标签页（不移动鼠标）
3. ✅ 应该切换到该标签，不触发拖拽
4. **拖动**标签页（移动鼠标>5px）
5. ✅ 应该开始拖拽，可以拆分或合并

## 优化前后对比

| 功能 | 优化前 | 优化后 |
|------|--------|--------|
| 合并预览 | ❌ 无提示 | ✅ 明显的蓝色高亮+文字提示 |
| 标签宽度 | ❌ 可能被截断 | ✅ 自动扩展，全部显示 |
| 点击标签 | ❌ 误触发拖拽 | ✅ 正确切换标签 |
| 拖拽体验 | ❌ 不准确 | ✅ 5px阈值，更精确 |

## 注意事项

1. **面板最大宽度限制**：为了避免面板过宽，设置了800px的最大宽度限制
2. **拖拽阈值**：设置为5px，可以根据需要调整
3. **标签宽度计算**：文字宽度按每字符8px估算，对于中文可能需要调整

## 后续优化建议

1. **响应式标签宽度**  
   当面板宽度不足时，可以让标签页自动缩小（但不小于最小宽度）

2. **标签滚动**  
   当标签页特别多时，可以添加左右滚动按钮

3. **标签拖拽排序**  
   支持在同一面板组内拖拽标签页调整顺序

4. **性能优化**  
   可以使用 `requestAnimationFrame` 优化拖拽时的性能

---

**优化日期**: 2026-01-14  
**版本**: v1.1.0  
**状态**: ✅ 已完成
