# 10、标签拖拽交互优化说明

> 本文档记录了对标签拖拽交互体验的全面优化

## 优化时间
2026-01-15

## 优化内容

### 1. 添加面板组标签栏的热区指示器

**问题**：当拖拽标签到面板组时，用户不知道哪些位置是可以插入的有效热区。

**解决方案**：
- 在标签栏容器添加 `has-hover-zone` 类，显示浅蓝色背景
- 为有效的热区标签添加 `is-hot-zone` 类，显示高亮效果
- 实现 `isTabHotZone()` 函数，智能判断哪些标签是有效热区

**代码位置**：
```vue
// src/components/docking/DockablePanelGroup.vue
<div 
  class="panel-tabs-container"
  :class="{ 'has-hover-zone': showHoverZone }"
>
  <div
    v-for="(tab, index) in group.tabs"
    class="panel-tab"
    :class="{ 
      'is-active': tab.id === group.activeTabId,
      'is-hot-zone': isTabHotZone(index)
    }"
  >
```

**判断逻辑**：
```typescript
function isTabHotZone(index: number): boolean {
  const tabDragInfo = manager.tabDragInfo?.value;
  if (!tabDragInfo) return false;
  
  // 不在当前面板组
  if (tabDragInfo.hoveredGroupId !== props.group.id) return false;
  
  // 如果是同一面板组内拖动
  if (tabDragInfo.groupId === props.group.id) {
    const sourceTabIndex = props.group.tabs.findIndex(t => t.id === tabDragInfo.tabId);
    
    // 源标签及其紧邻的位置不是热区
    if (index === sourceTabIndex || index === sourceTabIndex - 1 || index === sourceTabIndex + 1) {
      return false;
    }
  }
  
  // 其他标签都是热区
  return true;
}
```

**效果**：
- 拖拽标签到面板组时，标签栏显示浅蓝色背景
- 有效热区的标签显示蓝色高亮
- 无效位置的标签不显示高亮

---

### 2. 实现标签拖拽时的实时跟随效果

**问题**：拖拽多标签面板组中的标签时，被拖拽的标签不跟随鼠标移动，只有松开鼠标才显示，用户体验不佳。

**解决方案**：
- 在 `DockContainer.vue` 中添加标签拖拽预览元素
- 预览元素实时跟随鼠标位置
- 显示标签的图标和标题

**代码位置**：
```vue
// src/components/docking/DockContainer.vue
<!-- 标签拖拽预览 -->
<div 
  v-if="tabDragInfo && draggedTab" 
  class="tab-drag-preview"
  :style="getTabPreviewStyle()"
>
  <span v-if="draggedTab.icon" class="tab-preview-icon">{{ draggedTab.icon }}</span>
  <span class="tab-preview-title">{{ draggedTab.title }}</span>
</div>
```

**获取拖拽标签**：
```typescript
const draggedTab = computed(() => {
  if (!tabDragInfo.value) return null;
  
  const sourceGroup = manager.getPanelGroup?.(tabDragInfo.value.groupId);
  if (!sourceGroup) return null;
  
  return sourceGroup.tabs.find(t => t.id === tabDragInfo.value?.tabId);
});
```

**预览样式**：
```typescript
function getTabPreviewStyle() {
  if (!tabDragInfo.value) return {};
  
  return {
    left: `${tabDragInfo.value.currentX + 10}px`,
    top: `${tabDragInfo.value.currentY + 10}px`,
  };
}
```

**CSS样式**：
```css
.tab-drag-preview {
  position: fixed;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  min-width: 120px;
  background-color: #2d2d2d;
  border: 1px solid #4A90E2;
  border-radius: 4px;
  pointer-events: none;
  z-index: 10000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  opacity: 0.9;
}
```

**效果**：
- 拖拽标签时，标签跟随鼠标实时移动
- 预览显示标签的图标和标题
- 半透明效果，不遮挡下方内容

---

### 3. 优化面板内部拖拽的有效停靠热区逻辑

**问题**：在面板组内部拖动标签调整顺序时，所有位置都显示为可插入，包括无意义的位置（如拖动第一个标签到第一个位置前）。

**解决方案**：
- 在 `detectTabHover` 函数中添加有效性判断
- 排除源标签的当前位置和紧邻的下一个位置
- 如果插入位置无效，设置 `insertIndex` 为 `undefined`

**代码位置**：
```typescript
// src/components/docking/useDockManager.ts
// 如果是同一面板组内拖动，需要排除无效位置
if (id === sourceGroupId) {
  const sourceTabIndex = group.tabs.findIndex(t => t.id === sourceTabId);
  if (sourceTabIndex !== -1) {
    // 如果插入位置是源标签的当前位置或紧接着的下一个位置，则无效
    if (insertIndex === sourceTabIndex || insertIndex === sourceTabIndex + 1) {
      // 清除插入位置，表示无效
      tabDragInfo.value.hoveredGroupId = id;
      tabDragInfo.value.insertIndex = undefined;
      break;
    }
  }
}
```

**判断逻辑说明**：
- 例如有3个标签：tab1(index=0), tab2(index=1), tab3(index=2)
- 拖动tab1时：
  - index=0（tab1前面）：无效，因为就是当前位置
  - index=1（tab1和tab2之间）：无效，因为没有变化
  - index=2（tab2和tab3之间）：有效
  - index=3（tab3后面）：有效

**配合显示逻辑**：
```typescript
// src/components/docking/DockablePanelGroup.vue
function showInsertIndicator(index: number): boolean {
  const tabDragInfo = manager.tabDragInfo?.value;
  if (!tabDragInfo) return false;
  
  if (tabDragInfo.hoveredGroupId !== props.group.id) return false;
  
  // 如果插入位置未定义（无效位置），不显示
  if (tabDragInfo.insertIndex === undefined) return false;
  
  return tabDragInfo.insertIndex === index;
}
```

**效果**：
- 只在有效位置显示插入指示线
- 无效位置不显示任何提示
- 提升用户体验，避免困惑

---

### 4. 修复容器边缘的热区显示

**问题**：拖拽标签到容器边缘时，热区指示器不显示。

**解决方案**：
- 在 `onDragTab` 函数中确保调用 `detectTabDockSnap`
- 检测容器边缘和已停靠面板的吸附区域
- 正确设置 `hoveredZone` 值

**代码位置**：
```typescript
// src/components/docking/useDockManager.ts
function onDragTab(clientX: number, clientY: number) {
  if (!tabDragInfo.value) return;

  tabDragInfo.value.currentX = clientX;
  tabDragInfo.value.currentY = clientY;

  // 优先检测面板组标签栏
  detectTabHover(clientX, clientY);

  // 如果悬停在面板组标签栏上，清除停靠预览
  if (tabDragInfo.value.hoveredGroupId) {
    tabDragInfo.value.dockZone = null;
    hoveredZone.value = null;
    return;
  }

  // 检测停靠区域
  const dockSnapResult = detectTabDockSnap(clientX, clientY);
  if (dockSnapResult.shouldSnap) {
    tabDragInfo.value.dockZone = {
      position: dockSnapResult.position!,
      rect: dockSnapResult.targetRect!,
    };
    hoveredZone.value = tabDragInfo.value.dockZone;
  } else {
    tabDragInfo.value.dockZone = null;
    hoveredZone.value = null;
  }
}
```

**检测函数**：
```typescript
function detectTabDockSnap(mouseX: number, mouseY: number): SnapResult {
  if (!containerRect.value) {
    return { shouldSnap: false };
  }

  const containerR = containerRect.value;

  // 1. 检测容器边缘吸附
  const edgeSnap = detectContainerEdgeSnap(mouseX, mouseY, containerR);
  if (edgeSnap.shouldSnap) {
    return edgeSnap;
  }

  // 2. 检测已停靠面板/面板组的吸附
  const dockSnap = detectTabToDockSnap(mouseX, mouseY);
  if (dockSnap.shouldSnap) {
    return dockSnap;
  }

  return { shouldSnap: false };
}
```

**效果**：
- 拖拽标签到容器边缘，显示蓝色半透明热区
- 拖拽标签到已停靠面板附近，显示停靠位置预览
- 热区指示器正常工作

---

### 5. 处理panel热区和容器热区的优先级

**问题**：当面板组的标签栏热区和容器边缘热区重叠时，两个热区都显示，造成视觉混乱。

**解决方案**：
- 设置优先级：面板组标签栏 > 容器边缘热区
- 在 `onDragTab` 函数中先检测标签栏
- 如果检测到标签栏悬停，立即返回，不再检测容器热区

**代码逻辑**：
```typescript
function onDragTab(clientX: number, clientY: number) {
  // 1. 优先检测面板组标签栏（最高优先级）
  detectTabHover(clientX, clientY);

  // 2. 如果悬停在面板组标签栏上，清除停靠预览并返回
  if (tabDragInfo.value.hoveredGroupId) {
    tabDragInfo.value.dockZone = null;
    hoveredZone.value = null;
    return; // 关键：立即返回，不再检测容器热区
  }

  // 3. 如果没有悬停在标签栏上，才检测停靠区域
  const dockSnapResult = detectTabDockSnap(clientX, clientY);
  // ...
}
```

**优先级说明**：
1. **最高优先级**：面板组标签栏（用于合并标签）
2. **次要优先级**：容器边缘和已停靠面板（用于停靠）

**效果**：
- 拖拽到面板组标签栏：只显示标签栏热区高亮和插入指示线
- 拖拽到容器边缘：显示容器热区预览
- 不会同时显示多个热区，避免混乱

---

## 优化效果总结

### 视觉体验改进
1. **热区指示更直观**：标签栏显示浅蓝色背景，有效标签高亮
2. **拖拽预览更流畅**：标签跟随鼠标实时移动，半透明效果
3. **插入位置更精确**：只在有效位置显示蓝色指示线
4. **容器热区更清晰**：边缘热区正常显示，预览区域明确
5. **优先级更合理**：不会同时显示多个热区，避免混乱

### 交互逻辑改进
1. **热区判断更智能**：排除无效位置，只显示有意义的热区
2. **拖拽反馈更即时**：预览跟随鼠标，实时显示拖拽内容
3. **优先级更明确**：标签栏优先于容器，逻辑清晰
4. **有效性更精确**：同组内拖动排除相邻位置，避免无效操作

### 用户体验提升
- **学习成本更低**：视觉提示清晰，用户一看就懂
- **操作反馈更好**：拖拽预览实时跟随，心理预期明确
- **错误操作更少**：无效位置不显示提示，避免误操作
- **工作效率更高**：热区清晰，快速定位插入位置

---

## 测试建议

### 测试场景1：标签栏热区显示
1. 创建两个面板组，每个有多个标签
2. 从一个组拖动标签到另一个组的标签栏
3. 预期：
   - 标签栏显示浅蓝色背景
   - 有效热区的标签显示蓝色高亮
   - 鼠标移动时，热区标签动态更新

### 测试场景2：标签拖拽预览
1. 创建一个有多个标签的面板组
2. 拖动其中一个标签
3. 预期：
   - 标签预览跟随鼠标实时移动
   - 预览显示标签的图标和标题
   - 预览半透明，不遮挡下方内容

### 测试场景3：有效热区判断
1. 创建一个有3个标签的面板组：tab1, tab2, tab3
2. 拖动tab1到不同位置
3. 预期：
   - tab1前面（index=0）：不显示插入线（无效）
   - tab1和tab2之间（index=1）：不显示插入线（无效）
   - tab2和tab3之间（index=2）：显示插入线（有效）
   - tab3后面（index=3）：显示插入线（有效）

### 测试场景4：容器热区显示
1. 创建一个面板组
2. 拖动标签到容器左侧边缘
3. 预期：
   - 显示蓝色半透明热区预览
   - 热区覆盖左侧区域
   - 释放鼠标后，标签停靠到左侧

### 测试场景5：热区优先级
1. 创建一个停靠在左侧的面板组
2. 拖动另一个标签，悬停在该面板组的标签栏上
3. 预期：只显示标签栏热区高亮，不显示容器热区
4. 将标签移到标签栏外但靠近左侧边缘
5. 预期：显示容器边缘热区预览

### 测试场景6：跨组拖拽
1. 创建panel1（有tab1, tab2）和panel2（有tab3, tab4）
2. 拖动tab1到panel2的标签栏
3. 预期：
   - panel2的标签栏显示浅蓝色背景
   - tab3和tab4显示热区高亮
   - 可以插入到tab3前、tab3和tab4之间、tab4后

---

## 技术要点

### 1. 拖拽预览的实现
- 使用 `computed` 属性获取被拖拽的标签信息
- 使用 `fixed` 定位，`z-index: 10000` 确保在最上层
- 使用 `pointer-events: none` 避免干扰鼠标事件
- 预览位置偏移 `(+10, +10)`，避免遮挡鼠标指针

### 2. 热区判断的逻辑
```typescript
// 有效热区的条件：
1. 悬停在当前面板组
2. 不是源标签的当前位置
3. 不是源标签的紧邻位置（上一个或下一个）
```

### 3. 优先级控制的关键
```typescript
// 使用早返回（early return）模式
if (condition1) {
  // 处理高优先级情况
  return; // 关键：立即返回
}
// 只有高优先级条件不满足时，才执行低优先级逻辑
```

### 4. 热区样式的设计
- 使用半透明背景，不完全遮挡内容
- 使用蓝色系，与系统主题一致
- 使用过渡动画，平滑切换状态

---

## 相关文件

### 修改的文件
1. `src/components/docking/DockContainer.vue`
   - 添加标签拖拽预览元素
   - 添加预览样式函数
   - 添加拖拽预览CSS样式

2. `src/components/docking/useDockManager.ts`
   - 优化 `onDragTab` 函数，处理优先级
   - 优化 `detectTabHover` 函数，判断有效性

3. `src/components/docking/DockablePanelGroup.vue`
   - 添加热区高亮类绑定
   - 添加 `showHoverZone` 计算属性
   - 添加 `isTabHotZone` 函数
   - 添加热区样式CSS

### 新增的功能
1. **标签拖拽预览**：实时跟随鼠标的标签预览
2. **热区智能判断**：区分有效和无效热区
3. **热区视觉反馈**：标签栏背景和标签高亮
4. **优先级控制**：标签栏优先于容器热区

### 修改的函数
1. `onDragTab()` - 添加优先级控制
2. `detectTabHover()` - 添加有效性判断
3. `showInsertIndicator()` - 处理无效位置
4. 新增 `isTabHotZone()` - 判断热区标签
5. 新增 `showHoverZone` - 判断是否显示热区

---

## 后续优化建议

1. **性能优化**：
   - 热区判断可以添加节流，减少计算频率
   - 预览元素可以使用 `transform` 代替 `left/top`，提升性能

2. **视觉优化**：
   - 添加热区过渡动画，平滑切换
   - 添加拖拽预览的缩放动画

3. **交互优化**：
   - 添加键盘快捷键（如按住Shift强制拆分）
   - 添加拖拽方向判断（左右拖动优先视为排序）

4. **可配置性**：
   - 热区判断逻辑可配置
   - 拖拽预览样式可自定义
   - 优先级规则可配置

---

## 版本信息
- 优化版本：v1.5
- 优化日期：2026-01-15
- 优化人员：AI Assistant
