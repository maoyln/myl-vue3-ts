# Vue3 实现 PS 风格拖拽停泊吸附功能 - 工具类与组件拆解分析

核心设计思路：基于 Vue3 Composition API 实现逻辑复用，通过「工具类封装核心算法」「基础组件承载通用交互」「业务组件实现具体功能」的分层设计，结合自定义指令、Teleport 等 Vue3 特性，确保功能可复用、可扩展，同时贴合 PS 原生交互体验。以下拆解覆盖吸附计算、拖拽交互、停泊管理、视觉反馈全流程。

## 一、核心工具类（封装纯逻辑，无关 UI，支持跨组件复用）

工具类采用 Vue3 组合式函数（Composables）或普通 Class 封装，专注于算法计算、状态管理，不直接操作 DOM，通过参数注入和回调函数与组件交互。

### 1. 吸附计算工具类：`useSnapCalculator.ts`（组合式函数）

#### 核心作用

封装所有吸附相关的计算逻辑，包括吸附触发判断、对齐位置校准、吸附类型识别，是吸附功能的核心算法模块，为拖拽组件提供精准的位置计算支持。

#### 核心功能点（对应需求映射）

- 计算元素完整位置信息（包含相对父容器的 x/y、中心坐标、边缘坐标），支撑所有吸附规则的基础数据；

- 判断吸附触发条件：根据组件边缘与目标（其他组件/停泊区）的距离、拖拽速度，确定是否触发吸附（对应「吸附触发条件」需求）；

- 校准吸附位置：根据对齐规则（组件间左/右/中心对齐、停泊区边缘/网格对齐、等距对齐），计算校准后的组件坐标（对应「吸附对齐规则」需求）；

- 识别吸附类型与取消逻辑：返回当前触发的吸附类型（如 left/centerY），并提供吸附取消的判断逻辑（距离超出、Alt 键触发等，对应「吸附取消规则」需求）。

#### 技术实现核心

基于 TypeScript 类型约束（定义 ElementRect、SnapType 等接口），通过纯函数计算位置关系，避免副作用；提供响应式参数（如吸附距离、拖拽速度），支持实时调整；通过回调函数（如 onSnap、onSnapCancel）向组件传递吸附状态变更。

### 2. 停泊区域管理工具类：`useDockManager.ts`（组合式函数）

#### 核心作用

管理所有停泊区的状态（默认停泊区+自定义停泊区），处理组件与停泊区的关联逻辑（停泊/脱离停泊、排列顺序调整、组合面板管理），是停泊功能的核心调度模块。

#### 核心功能点（对应需求映射）

- 停泊区初始化与配置：维护4个基础停泊区（左/右/上/下）和用户自定义停泊区的状态，支持停泊区展开/折叠状态管理（对应「停泊区定义与布局」需求）；

- 停泊/脱离判断：判断拖拽组件是否进入停泊区范围，触发停泊吸附或脱离停泊逻辑（对应「组件停泊规则」需求）；

- 停泊区组件排序与组合：管理同一停泊区内组件的排列顺序（横向/纵向），处理组合面板的创建/拆分逻辑，维护组件的父子组合关系（对应「组件停泊规则」「状态切换需求」）；

- 工作区预设管理：支持自定义停泊区布局的保存、加载与删除（对应「扩展性与配置需求」中的工作区预设功能）。

#### 技术实现核心

使用 Vue3 响应式数据（ref/reactive）维护停泊区列表、组件停泊状态；通过发布-订阅模式（如 mitt 库）监听组件拖拽事件，触发停泊区状态更新；提供统一的 API（如 dockComponent、undockComponent、combineComponents）供组件调用。

### 3. 拖拽状态管理工具类：`useDragState.ts`（组合式函数）

#### 核心作用

统一管理拖拽全流程的状态（拖拽中/结束、当前拖拽组件、鼠标偏移量、拖拽速度），处理拖拽边界约束和异常场景（应用失焦、Esc 键取消），为拖拽组件提供通用的状态支撑。

#### 核心功能点（对应需求映射）

- 拖拽状态维护：记录当前是否处于拖拽中、当前拖拽的组件实例、鼠标相对于组件的偏移量（避免瞬移）（对应「拖拽触发需求」）；

- 边界约束计算：限制组件拖拽范围在主窗口内，避免组件被裁剪，处理窗口大小调整时的组件位置自适应（对应「拖拽边界约束需求」）；

- 异常场景处理：监听应用失焦、Esc 键按下事件，触发拖拽取消逻辑，让组件返回初始位置（对应「异常场景处理」需求）；

- 拖拽速度计算：实时计算拖拽速度，为吸附延迟触发提供数据支撑（对应「吸附触发条件」中快速划过目标区域的处理）。

#### 技术实现核心

通过监听鼠标/触摸事件（mousedown/mousemove/mouseup、touchstart/touchmove/touchend）维护拖拽状态；使用节流函数优化 mousemove 事件触发频率，保障性能；通过 Vue3 生命周期钩子自动解绑事件，避免内存泄漏。

## 二、基础组件（封装通用 UI 与交互，可直接复用）

基础组件基于 Vue3 单文件组件（SFC）实现，集成工具类的核心逻辑，封装通用的 UI 结构和交互行为，支持通过 props 自定义配置，适配不同业务场景。

### 1. 可拖拽组件：`DraggablePanel.vue`

#### 核心作用

所有可拖拽组件的基础封装，提供统一的拖拽触发（标题栏）、位置更新、状态反馈功能，是图层面板、属性面板等业务组件的父组件。

#### 核心功能点（对应需求映射）

- 拖拽触发与视觉反馈：仅允许通过标题栏触发拖拽，拖拽时显示标题栏高亮、跟随阴影（对应「拖拽触发需求」「拖拽过程反馈」）；

- 位置响应式更新：接收 useSnapCalculator 计算的校准位置，通过 CSS 动态更新组件位置，确保移动平滑无卡顿（对应「拖拽过程需求」）；

- 状态切换支持：支持浮动/停泊/组合三种状态的切换，接收 useDockManager 的状态通知，触发对应的嵌入/弹出动画（对应「状态切换需求」「状态变更反馈」）；

- 自定义配置支持：通过 props 配置吸附距离、是否可拖拽、组件大小等参数（对应「扩展性与配置需求」）。

#### 技术实现核心

在 setup 中集成 useDragState、useSnapCalculator 工具类，通过 Teleport 组件将组件挂载到指定容器（避免层级问题）；使用 Vue3 自定义事件（如 drag-start、drag-end、snap）向父组件传递状态；通过 CSS 变量和过渡动画实现视觉反馈。

### 2. 停泊区容器组件：`DockContainer.vue`

#### 核心作用

承载停泊区的 UI 结构，管理停泊在区内的组件排列（横向/纵向），提供停泊区展开/折叠控制，是基础停泊区和自定义停泊区的统一实现。

#### 核心功能点（对应需求映射）

- 停泊区布局渲染：根据配置渲染横向（上下停泊区）或纵向（左右停泊区）布局，自动适配窗口大小（对应「停泊区定义与布局」）；

- 组件排列与滚动：同一停泊区内组件自动并列/堆叠排列，超出范围时显示滚动条（对应「组件停泊规则」）；

- 展开/折叠控制：提供折叠按钮，折叠后仅显示组件标题栏，展开后显示完整内容（对应「停泊区定义与布局」）；

- 停泊预览反馈：当组件拖拽至停泊区范围时，显示半透明预览框，提示停泊位置（对应「拖拽过程反馈」）。

#### 技术实现核心

集成 useDockManager 工具类，通过响应式数据监听停泊区状态和组件列表变化；使用 Flex 布局实现组件的横向/纵向排列，通过 overflow 属性控制滚动；通过 v-if 控制展开/折叠状态的 UI 切换，配合过渡动画提升体验。

### 3. 对齐辅助线组件：`GuideLine.vue`

#### 核心作用

封装吸附对齐时的视觉反馈 UI，根据吸附类型（水平/垂直）动态渲染辅助线，支持自定义样式，全局唯一实例（避免重复渲染）。

#### 核心功能点（对应需求映射）

- 动态渲染辅助线：根据 useSnapCalculator 传递的吸附类型，渲染水平或垂直辅助线，仅在吸附方向显示（对应「吸附触发条件」「拖拽过程反馈」）；

- 样式自定义：支持通过 props 配置辅助线颜色、宽度、层级（对应「扩展性与配置需求」）；

- 显示/隐藏控制：吸附触发时显示，吸附取消或拖拽结束时隐藏（对应「吸附取消规则」）。

#### 技术实现核心

使用 Teleport 将辅助线挂载到 body 节点（确保层级最高，不被其他组件遮挡）；通过响应式数据（ref）控制辅助线的位置、方向和显示状态；使用 CSS 实现半透明效果和实线样式，贴合 PS 原生视觉。

### 4. 组合面板组件：`CombinedPanel.vue`

#### 核心作用

封装组合面板的 UI 结构和交互逻辑，支持多个 DraggablePanel 组件的组合/拆分，提供组合标题栏、子面板切换功能。

#### 核心功能点（对应需求映射）

- 组合面板渲染：将多个子面板组合成一个整体，显示统一的组合标题栏和子面板切换标签（对应「组件停泊规则」「状态切换需求」）；

- 组合/拆分控制：支持通过拖拽子面板至组合区域触发组合，通过右键菜单选择「拆分面板」触发拆分（对应「状态切换需求」）；

- 过渡动画：组合/拆分时显示组件位置平滑调整的过渡动画（对应「状态变更反馈」）；

- 整体拖拽支持：组合后的面板可作为一个整体进行拖拽和停泊（对应「组件停泊规则」）。

#### 技术实现核心

集成 useDockManager 工具类，维护子面板列表和组合状态；使用 Vue3 的动态组件（<component :is="currentPanel">）渲染当前激活的子面板；通过自定义事件与 DraggablePanel 组件通信，触发组合/拆分逻辑。

## 三、自定义指令（补充组件交互，简化代码复用）

基于 Vue3 自定义指令封装通用交互逻辑，简化组件内的事件监听和 DOM 操作代码。

### 1. 拖拽触发指令：`v-drag-trigger`

#### 核心作用

简化 DraggablePanel 组件的拖拽触发逻辑，仅需将指令绑定到标题栏元素，即可实现拖拽触发、鼠标偏移量计算等功能。

#### 技术实现核心

在指令的 mounted 钩子中监听 mousedown/touchstart 事件，触发拖拽开始逻辑；通过指令参数传递拖拽配置（如是否可拖拽）；在 unmounted 钩子中解绑事件，避免内存泄漏。

### 2. 吸附区域指令：`v-snap-area`

#### 核心作用

标记可吸附的区域（如停泊区、其他组件），简化吸附触发的区域判断逻辑，避免在组件内重复编写区域检测代码。

#### 技术实现核心

在指令的 mounted 钩子中获取绑定元素的位置信息，注册到 useSnapCalculator 工具类的吸附区域列表；在 unmounted 钩子中移除注册，确保吸附区域的动态更新。

## 四、组件/工具类依赖关系与数据流转

1. 数据流转：DraggablePanel 组件通过 v-drag-trigger 指令触发拖拽 → useDragState 记录拖拽状态 → useSnapCalculator 接收拖拽位置，结合 v-snap-area 标记的吸附区域，计算校准位置 → DraggablePanel 根据校准位置更新 UI，同时触发 GuideLine 组件显示辅助线；

2. 停泊逻辑：DraggablePanel 拖拽至 DockContainer 区域 → useDockManager 检测到停泊条件 → 触发停泊逻辑，更新组件停泊状态 → DockContainer 重新排列区内组件，DraggablePanel 显示嵌入动画；

3. 组合逻辑：多个 DraggablePanel 拖拽至组合区域 → useDockManager 处理组合关系 → CombinedPanel 组件渲染组合 UI → 组合面板整体可拖拽、停泊、拆分。

## 五、核心优势（贴合 Vue3 特性）

- 逻辑复用高效：通过组合式函数（Composables）封装核心算法，避免重复代码，支持跨组件复用；

- 响应式体验流畅：基于 Vue3 响应式系统，组件状态与位置实时同步，配合过渡动画，提升交互体验；

- 扩展性强：通过 props、自定义事件、指令参数，支持组件功能的灵活配置，适配不同业务场景；

- 工程化友好：组件分层清晰，工具类与 UI 分离，便于单元测试和后期维护。
> （注：文档部分内容可能由 AI 生成）